      
        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Tracker App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-button.active {
            background: white;
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .location-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            margin-left: 10px;
        }

        .customer-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .customer-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .customer-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .customer-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        .payment-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-partial {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .payment-buttons {
            margin-top: 15px;
        }

        .payment-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-right: 10px;
        }

        .location-info {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .summary-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .summary-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .customer-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Sales Tracker Pro</h1>
            <p>Manage your door-to-door sales and payments efficiently</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('add-customer')">‚ûï Add Customer</button>
            <button class="tab-button" onclick="showTab('customers')">üë• Customers</button>
            <button class="tab-button" onclick="showTab('dashboard')">üìä Dashboard</button>
        </div>

        <!-- Add Customer Tab -->
        <div id="add-customer" class="tab-content active">
            <h2>Add New Customer & Sale</h2>
            <form id="customerForm">
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="customerName">Customer Name *</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone Number *</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email</label>
                            <input type="email" id="customerEmail">
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address *</label>
                            <textarea id="customerAddress" rows="3" required></textarea>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label for="productName">Product Name *</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Total Product Price (Rs) *</label>
                            <input type="number" id="productPrice" min="0" step="0.01" required placeholder="e.g., 50000">
                        </div>
                        <div class="form-group">
                            <label for="downPayment">Down Payment (Rs) *</label>
                            <input type="number" id="downPayment" min="0" step="0.01" required placeholder="e.g., 10000">
                        </div>
                        <div class="form-group">
                            <label for="monthlyPayment">Monthly Payment (Rs)</label>
                            <input type="number" id="monthlyPayment" min="0" step="0.01" placeholder="Auto-calculated">
                        </div>
                        <div class="form-group">
                            <label for="paymentMonths">Payment Duration (months)</label>
                            <input type="number" id="paymentMonths" min="1" max="60">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="location">Customer Location</label>
                    <input type="text" id="location" placeholder="Will auto-fill when you get location or enter address" readonly>
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn location-btn" onclick="getCurrentLocation()">üìç Get Current Location</button>
                        <button type="button" class="btn location-btn" onclick="getLocationFromAddress()" style="background: linear-gradient(135deg, #28a745, #20c997);">üó∫Ô∏è Get Location from Address</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Additional Notes</label>
                    <textarea id="notes" rows="3" placeholder="Any special instructions or notes..."></textarea>
                </div>

                <button type="submit" class="btn">üíæ Save Customer & Sale</button>
            </form>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <h2>Customer Management</h2>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Search customers by name, phone, or product..." onkeyup="searchCustomers()">
            </div>
            <div id="customersList">
                <p style="text-align: center; color: #666; padding: 40px;">No customers added yet. Add your first customer to get started!</p>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2>Sales Dashboard</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <h3 id="totalCustomers">0</h3>
                    <p>Total Customers</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalSales">Rs 0</h3>
                    <p>Total Sales</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalReceived">Rs 0</h3>
                    <p>Amount Received</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalPending">Rs 0</h3>
                    <p>Amount Pending</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePaymentModal()">&times;</span>
            <h2>Record Payment</h2>
            <form id="paymentForm">
                <div class="form-group">
                    <label for="paymentAmount">Payment Amount (Rs)</label>
                    <input type="number" id="paymentAmount" min="0" step="0.01" required placeholder="e.g., 5000">
                </div>
                <div class="form-group">
                    <label for="paymentDate">Payment Date</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label for="paymentNotes">Payment Notes</label>
                    <textarea id="paymentNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn">üí∞ Record Payment</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script>
        let customers = [];
        let currentPaymentCustomerId = null;

        // Load data on page load
        window.addEventListener('load', function() {
            loadCustomers();
            displayCustomers();
            updateDashboard();
        });

        function loadCustomers() {
            try {
                const savedData = localStorage.getItem('salesCustomers');
                if (savedData) {
                    customers = JSON.parse(savedData);
                    console.log('Loaded customers:', customers.length);
                } else {
                    customers = [];
                    console.log('No saved data found');
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                customers = [];
            }
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Update dashboard when dashboard tab is shown
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        function getCurrentLocation() {
            const locationInput = document.getElementById('location');
            locationInput.value = 'üîÑ Getting your current location...';
            
            if (!navigator.geolocation) {
                locationInput.value = '';
                alert('‚ùå Geolocation is not supported by this browser.\n\nPlease try:\n1. Using a modern browser (Chrome, Firefox, Safari)\n2. Enabling location services\n3. Using HTTPS connection');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000, // 15 seconds
                maximumAge: 300000 // 5 minutes
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    const accuracy = Math.round(position.coords.accuracy);
                    
                    locationInput.value = `üìç Coordinates: ${lat}, ${lng} (¬±${accuracy}m)`;
                    
                    console.log('Location obtained:', { lat, lng, accuracy });
                    
                    // Try to get readable address using multiple services
                    getReadableAddress(lat, lng, locationInput);
                },
                function(error) {
                    locationInput.value = '';
                    let errorMessage = '‚ùå Location Error: ';
                    let suggestion = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Permission denied.';
                            suggestion = '\n\nTo fix:\n1. Click the location icon in your browser address bar\n2. Allow location access\n3. Refresh the page and try again';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable.';
                            suggestion = '\n\nPossible fixes:\n1. Check your internet connection\n2. Enable GPS/location services\n3. Try again in a few moments';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            suggestion = '\n\nTry:\n1. Moving to an open area\n2. Checking your internet connection\n3. Trying again';
                            break;
                        default:
                            errorMessage += 'Unknown error occurred.';
                            suggestion = '\n\nTry refreshing the page and enabling location services.';
                            break;
                    }
                    
                    alert(errorMessage + suggestion);
                    console.error('Geolocation error:', error);
                },
                options
            );
        }

        function getReadableAddress(lat, lng, locationInput) {
            // Try OpenStreetMap Nominatim (free service)
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
                headers: {
                    'User-Agent': 'SalesTrackerApp/1.0'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Nominatim service unavailable');
                return response.json();
            })
            .then(data => {
                if (data && data.display_name) {
                    locationInput.value = `üìç ${data.display_name}`;
                    console.log('Address found:', data.display_name);
                } else {
                    throw new Error('No address found');
                }
            })
            .catch(error => {
                console.log('Address lookup failed:', error);
                // Fallback: try another service or keep coordinates
                tryAlternativeGeoService(lat, lng, locationInput);
            });
        }

        function tryAlternativeGeoService(lat, lng, locationInput) {
            // Try alternative service (geocode.xyz - free with rate limits)
            fetch(`https://geocode.xyz/${lat},${lng}?json=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.standard && data.standard.addresst) {
                    const address = `${data.standard.addresst}, ${data.standard.city}, ${data.standard.countryname}`;
                    locationInput.value = `üìç ${address}`;
                    console.log('Alternative address found:', address);
                } else {
                    throw new Error('Alternative service failed');
                }
            })
            .catch(error => {
                console.log('Alternative geocoding failed:', error);
                // Keep coordinates as final fallback
                locationInput.value = `üìç Lat: ${lat}, Lng: ${lng} (Address lookup unavailable)`;
            });
        }

        function getLocationFromAddress() {
            const address = document.getElementById('customerAddress').value.trim();
            const locationInput = document.getElementById('location');
            
            if (!address) {
                alert('‚ö†Ô∏è Please enter the customer address first, then click this button to get the location.');
                document.getElementById('customerAddress').focus();
                return;
            }
            
            locationInput.value = 'üîÑ Finding location from address...';
            
            // Use OpenStreetMap Nominatim for forward geocoding
            const encodedAddress = encodeURIComponent(address);
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1&addressdetails=1`, {
                headers: {
                    'User-Agent': 'SalesTrackerApp/1.0'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Geocoding service unavailable');
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat).toFixed(6);
                    const lng = parseFloat(result.lon).toFixed(6);
                    
                    locationInput.value = `üìç ${result.display_name} (${lat}, ${lng})`;
                    console.log('Address geocoded successfully:', result.display_name);
                    
                    // Optionally show accuracy info
                    if (result.importance) {
                        const confidence = Math.round(result.importance * 100);
                        console.log(`Geocoding confidence: ${confidence}%`);
                    }
                } else {
                    throw new Error('Address not found');
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
                locationInput.value = '';
                alert(`‚ùå Could not find location for this address.\n\nTips:\n1. Check the address spelling\n2. Include city/area name\n3. Try a more specific address\n4. Use the "Get Current Location" button instead\n\nAddress entered: "${address}"`);
            });
        }

        document.getElementById('customerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('=== FORM SUBMIT STARTED ===');
            
            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'üíæ Saving...';
            submitBtn.disabled = true;
            
            // Validate required fields
            const requiredFields = ['customerName', 'customerPhone', 'customerAddress', 'productName', 'productPrice', 'downPayment'];
            let isValid = true;
            
            console.log('Validating fields...');
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const value = field.value.trim();
                console.log(`${fieldId}: "${value}"`);
                if (!value) {
                    field.style.borderColor = '#ff6b6b';
                    isValid = false;
                } else {
                    field.style.borderColor = '#e1e5e9';
                }
            });
            
            if (!isValid) {
                console.log('‚ùå Validation failed');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                alert('Please fill in all required fields (marked with *)');
                return;
            }
            
            const totalPrice = parseFloat(document.getElementById('productPrice').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            
            console.log('Total Price:', totalPrice, 'Down Payment:', downPayment);
            
            if (downPayment > totalPrice) {
                console.log('‚ùå Down payment too high');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                alert('Down payment cannot be more than total price');
                return;
            }
            
            console.log('Creating customer data...');
            const customerData = {
                id: 'temp_' + Date.now(), // Temporary ID, will be replaced by Firebase
                name: document.getElementById('customerName').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                email: document.getElementById('customerEmail').value.trim(),
                address: document.getElementById('customerAddress').value.trim(),
                product: document.getElementById('productName').value.trim(),
                totalPrice: totalPrice,
                downPayment: downPayment,
                monthlyPayment: parseFloat(document.getElementById('monthlyPayment').value) || 0,
                paymentMonths: parseInt(document.getElementById('paymentMonths').value) || 0,
                location: document.getElementById('location').value.trim(),
                notes: document.getElementById('notes').value.trim(),
                dateAdded: new Date().toISOString(), // Use ISO format for better sorting
                payments: [{
                    amount: downPayment,
                    date: new Date().toISOString(),
                    type: 'Down Payment',
                    notes: 'Initial payment'
                }],
                totalPaid: downPayment,
                remainingAmount: totalPrice - downPayment
            };

            console.log('Customer data created:', customerData);
            
            // Save to Firebase
            const saveSuccess = await saveCustomerToFirebase(customerData);
            
            if (saveSuccess) {
                console.log('‚úÖ Customer saved to Firebase successfully');
                
                // Add to local array
                customers.unshift(customerData); // Add to beginning for newest first
                
                // Update display
                displayCustomers();
                updateDashboard();
                
                // Reset form
                document.getElementById('customerForm').reset();
                
                // Show success message
                const message = `‚úÖ Customer ${customerData.name} saved successfully!\n\nüìä Details:\n‚Ä¢ Total Price: Rs ${totalPrice.toFixed(2)}\n‚Ä¢ Down Payment: Rs ${downPayment.toFixed(2)}\n‚Ä¢ Remaining: Rs ${customerData.remainingAmount.toFixed(2)}\n‚Ä¢ Total Customers: ${customers.length}\n\nüî• Data saved to Firebase database permanently!`;
                
                alert(message);
                
                // Switch to customers tab
                showTab('customers');
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                
            } else {
                console.log('‚ùå Save to Firebase failed');
            }
            
            // Reset button
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            
            console.log('=== FORM SUBMIT COMPLETED ===');
        });

        function displayCustomers() {
            const customersList = document.getElementById('customersList');
            
            if (customers.length === 0) {
                customersList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No customers added yet. Add your first customer to get started!</p>';
                return;
            }

            customersList.innerHTML = customers.map(customer => {
                const paymentStatus = getPaymentStatus(customer);
                return `
                    <div class="customer-card">
                        <div class="customer-header">
                            <div class="customer-name">${customer.name}</div>
                            <div class="payment-status ${paymentStatus.class}">${paymentStatus.text}</div>
                        </div>
                        
                        <div class="customer-details">
                            <div class="detail-item">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">${customer.phone}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Product</div>
                                <div class="detail-value">${customer.product}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Price</div>
                                <div class="detail-value">Rs ${customer.totalPrice.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Paid</div>
                                <div class="detail-value">Rs ${customer.totalPaid.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Remaining</div>
                                <div class="detail-value">Rs ${customer.remainingAmount.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Date Added</div>
                                <div class="detail-value">${customer.dateAdded}</div>
                            </div>
                        </div>

                        ${customer.location ? `
                            <div class="location-info">
                                üìç <strong>Location:</strong> ${customer.location}
                            </div>
                        ` : ''}

                        <div class="payment-buttons">
                            <button class="payment-btn" onclick="openPaymentModal(${customer.id})">üí∞ Add Payment</button>
                            <button class="payment-btn" onclick="viewPaymentHistory(${customer.id})">üìã Payment History</button>
                            <button class="payment-btn" onclick="editCustomer(${customer.id})">‚úèÔ∏è Edit</button>
                            <button class="payment-btn" onclick="deleteCustomer('${customer.id}')" style="background: linear-gradient(135deg, #dc3545, #c82333);">üóëÔ∏è Delete</button>
                            <button class="payment-btn" onclick="deleteCustomer('${customer.id}')" style="background: linear-gradient(135deg, #dc3545, #c82333);">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getPaymentStatus(customer) {
            if (customer.remainingAmount <= 0) {
                return { class: 'status-completed', text: 'Paid in Full' };
            } else if (customer.totalPaid > customer.downPayment) {
                return { class: 'status-partial', text: 'Partial Payment' };
            } else {
                return { class: 'status-pending', text: 'Down Payment Only' };
            }
        }

        function openPaymentModal(customerId) {
            currentPaymentCustomerId = customerId;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentModal').style.display = 'block';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
            currentPaymentCustomerId = null;
        }

        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentNotes = document.getElementById('paymentNotes').value;

            const customer = customers.find(c => c.id === currentPaymentCustomerId);
            if (customer) {
                // Show loading state
                const submitBtn = document.querySelector('#paymentForm button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'üí∞ Recording...';
                submitBtn.disabled = true;

                // Add payment to customer data
                const newPayment = {
                    amount: paymentAmount,
                    date: paymentDate,
                    notes: paymentNotes,
                    type: 'Regular Payment',
                    timestamp: new Date().toISOString()
                };

                customer.payments.push(newPayment);
                customer.totalPaid += paymentAmount;
                customer.remainingAmount = customer.totalPrice - customer.totalPaid;

                // Update in Firebase
                const updateSuccess = await updateCustomerInFirebase(customer.id, {
                    payments: customer.payments,
                    totalPaid: customer.totalPaid,
                    remainingAmount: customer.remainingAmount
                });

                if (updateSuccess) {
                    displayCustomers();
                    updateDashboard();
                    closePaymentModal();
                    alert(`üí∞ Payment Recorded Successfully!\n\nAmount: Rs ${paymentAmount.toFixed(2)}\nRemaining Balance: Rs ${customer.remainingAmount.toFixed(2)}\nTotal Payments: ${customer.payments.length}\n\nüî• Updated in Firebase database!`);
                }

                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        function viewPaymentHistory(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                let historyText = `Payment History for ${customer.name}:\n\n`;
                historyText += `Product: ${customer.product}\n`;
                historyText += `Total Price: Rs ${customer.totalPrice.toFixed(2)}\n`;
                historyText += `Total Paid: Rs ${customer.totalPaid.toFixed(2)}\n`;
                historyText += `Remaining: Rs ${customer.remainingAmount.toFixed(2)}\n\n`;
                historyText += `Payment Details:\n`;
                customer.payments.forEach((payment, index) => {
                    historyText += `${index + 1}. ${payment.type}: Rs ${payment.amount.toFixed(2)} on ${payment.date}\n`;
                    if (payment.notes) historyText += `   Notes: ${payment.notes}\n`;
                });
                alert(historyText);
            }
        }

        function editCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                const newPhone = prompt('Edit phone number:', customer.phone);
                if (newPhone && newPhone.trim() !== '') {
                    const updatedPhone = newPhone.trim();
                    
                    // Update in Firebase
                    updateCustomerInFirebase(customerId, { phone: updatedPhone }).then(success => {
                        if (success) {
                            customer.phone = updatedPhone;
                            displayCustomers();
                            alert('üì± Phone number updated successfully!\n\nüî• Changes saved to Firebase database.');
                        }
                    });
                }
            }
        }

        async function deleteCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                const confirmDelete = confirm(`‚ö†Ô∏è Delete Customer: ${customer.name}?\n\nThis will permanently delete:\n‚Ä¢ Customer information\n‚Ä¢ All payment records\n‚Ä¢ This action cannot be undone\n\nAre you sure?`);
                
                if (confirmDelete) {
                    const deleteSuccess = await deleteCustomerFromFirebase(customerId);
                    if (deleteSuccess) {
                        // Remove from local array
                        customers = customers.filter(c => c.id !== customerId);
                        displayCustomers();
                        updateDashboard();
                        alert('üóëÔ∏è Customer deleted successfully!\n\nüî• Removed from Firebase database.');
                    }
                }
            }
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const customersList = document.getElementById('customersList');
            
            if (!searchTerm) {
                // Show all customers if search is empty
                displayCustomers();
                return;
            }
            
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.phone.includes(searchTerm) ||
                customer.product.toLowerCase().includes(searchTerm) ||
                customer.address.toLowerCase().includes(searchTerm)
            );
            
            if (filteredCustomers.length === 0) {
                customersList.innerHTML = `<p style="text-align: center; color: #666; padding: 40px;">No customers found matching "${searchTerm}"</p>`;
                return;
            }
            
            // Display filtered customers
            customersList.innerHTML = filteredCustomers.map(customer => {
                const paymentStatus = getPaymentStatus(customer);
                return `
                    <div class="customer-card">
                        <div class="customer-header">
                            <div class="customer-name">${customer.name}</div>
                            <div class="payment-status ${paymentStatus.class}">${paymentStatus.text}</div>
                        </div>
                        
                        <div class="customer-details">
                            <div class="detail-item">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">${customer.phone}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Product</div>
                                <div class="detail-value">${customer.product}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Price</div>
                                <div class="detail-value">Rs ${customer.totalPrice.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Paid</div>
                                <div class="detail-value">Rs ${customer.totalPaid.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Remaining</div>
                                <div class="detail-value">Rs ${customer.remainingAmount.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Date Added</div>
                                <div class="detail-value">${customer.dateAdded}</div>
                            </div>
                        </div>

                        ${customer.location ? `
                            <div class="location-info">
                                üìç <strong>Location:</strong> ${customer.location}
                            </div>
                        ` : ''}

                        <div class="payment-buttons">
                            <button class="payment-btn" onclick="openPaymentModal(${customer.id})">üí∞ Add Payment</button>
                            <button class="payment-btn" onclick="viewPaymentHistory(${customer.id})">üìã Payment History</button>
                            <button class="payment-btn" onclick="editCustomer(${customer.id})">‚úèÔ∏è Edit</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDashboard() {
            const totalCustomers = customers.length;
            const totalSales = customers.reduce((sum, customer) => sum + customer.totalPrice, 0);
            const totalReceived = customers.reduce((sum, customer) => sum + customer.totalPaid, 0);
            const totalPending = totalSales - totalReceived;

            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('totalSales').textContent = `Rs ${totalSales.toFixed(2)}`;
            document.getElementById('totalReceived').textContent = `Rs ${totalReceived.toFixed(2)}`;
            document.getElementById('totalPending').textContent = `Rs ${totalPending.toFixed(2)}`;
        }

        function saveCustomers() {
            try {
                localStorage.setItem('salesCustomers', JSON.stringify(customers));
                console.log('Customers saved successfully. Total customers:', customers.length);
                return true;
            } catch (error) {
                console.error('Error saving customers:', error);
                // Fallback: show data in console for manual backup
                console.log('Customer data (for backup):', JSON.stringify(customers, null, 2));
                alert('Warning: Data could not be saved to browser storage. Your data will be lost when you refresh the page.');
                return false;
            }
        }

        // Calculate monthly payment automatically
        document.getElementById('productPrice').addEventListener('input', calculateMonthlyPayment);
        document.getElementById('downPayment').addEventListener('input', calculateMonthlyPayment);
        document.getElementById('paymentMonths').addEventListener('input', calculateMonthlyPayment);

        function calculateMonthlyPayment() {
            const totalPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const months = parseInt(document.getElementById('paymentMonths').value) || 0;
            
            if (months > 0 && totalPrice > downPayment) {
                const remainingAmount = totalPrice - downPayment;
                const monthlyPayment = remainingAmount / months;
                document.getElementById('monthlyPayment').value = monthlyPayment.toFixed(2);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target === modal) {
                closePaymentModal();
            }
        }
    </script>
</body>
</html>